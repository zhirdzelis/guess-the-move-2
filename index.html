<!DOCTYPE html>
<html lang="lv">

<meta charset="UTF-8">
<title>Guess the Move – Morphy</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard.min.css">

<script>
const game = new Chess();

// Morphy – Konsultanti (balto gājiens)
game.load("rnbqkb1r/ppp2ppp/4pn2/3p4/2PP4/5N2/PP2PPPP/RNBQKB1R w KQkq - 0 4");

const board = Chessboard('board', {
  draggable: true,
  position: game.fen(),
  onDrop: onDrop
});

// ====================
// Stockfish INIT
// ====================
const engine = new Worker("stockfish.js");
let engineReady = false;

engine.onmessage = function (e) {
  const line = e.data;

  if (line === "uciok") {
    engine.postMessage("isready");
    return;
  }

  if (line === "readyok") {
    engineReady = true;
    console.log("Stockfish ready");
    return;
  }

  if (line.startsWith("bestmove")) {
    console.log("Best move:", line);
    return;
  }

  if (line.includes("score cp")) {
    const cp = parseInt(line.split("score cp ")[1]) / 100;

    let label = "❌ Kļūda";
    if (Math.abs(cp) < 0.2) label = "⭐ Precīzs";
    else if (Math.abs(cp) < 0.6) label = "✔ Labs";
    else if (Math.abs(cp) < 1.2) label = "⚠ Neprecīzs";

    document.getElementById("eval").innerText =
      `Novērtējums: ${cp.toFixed(2)} ${label}`;
  }
};

engine.postMessage("uci");

// ====================
// MOVE HANDLING
// ====================
function onDrop(from, to) {
  if (!engineReady) {
    alert("Stockfish vēl ielādējas, pagaidi 1–2 sekundes");
    return 'snapback';
  }

  const move = game.move({ from, to, promotion: 'q' });
  if (!move) return 'snapback';

  board.position(game.fen());

  engine.postMessage("position fen " + game.fen());
  engine.postMessage("go depth 15");
}
</script>
</body>

</html>
